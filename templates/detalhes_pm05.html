{% extends "base.html" %}

{% block title %}Detalhes PM05 - {{ item.numero_pm05 }}{% endblock %}

{% block content %}
<style>
    .detail-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        position: relative;
    }
    
    .detail-header.em-reparo {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b35 100%);
    }
    
    .detail-header.finalizado {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .status-badge-large {
        position: absolute;
        top: 20px;
        right: 30px;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 2px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.2);
    }
    
    .detail-body {
        padding: 30px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .info-card.warning {
        border-left-color: #ff8c00;
        background: #fff8f0;
    }
    
    .info-card.success {
        border-left-color: #28a745;
        background: #f0fff4;
    }
    
    .info-card.danger {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
    
    .info-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        word-break: break-word;
    }
    
    .timeline-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e1e8ed;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 30px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #667eea;
    }
    
    .timeline-item.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }
    
    .timeline-item.warning::before {
        background: #ff8c00;
        box-shadow: 0 0 0 2px #ff8c00;
    }
    
    .timeline-content {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px 20px;
        border-left: 3px solid #667eea;
    }
    
    .timeline-item.completed .timeline-content {
        border-left-color: #28a745;
        background: #f0fff4;
    }
    
    .timeline-item.warning .timeline-content {
        border-left-color: #ff8c00;
        background: #fff8f0;
    }
    
    .timeline-date {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .timeline-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #495057;
    }
    
    .timeline-description {
        color: #6c757d;
        margin-bottom: 0;
    }
    
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .document-card {
        background: white;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }
    
    .document-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102,126,234,0.2);
        text-decoration: none;
        color: inherit;
    }
    
    .document-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: #667eea;
    }
    
    .document-icon.pdf { color: #dc3545; }
    .document-icon.image { color: #17a2b8; }
    .document-icon.word { color: #0066cc; }
    
    .document-name {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9rem;
        word-break: break-word;
    }
    
    .document-size {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .action-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        position: sticky;
        top: 20px;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        margin-bottom: 10px;
        width: 100%;
        justify-content: center;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        text-decoration: none;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-success-custom {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .btn-warning-custom {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b35 100%);
        color: white;
    }
    
    .btn-secondary-custom {
        background: #6c757d;
        color: white;
    }
    
    .btn-danger-custom {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .days-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #17a2b8;
    }
    
    .days-indicator.warning {
        background: #fff8f0;
        border-left-color: #ff8c00;
    }
    
    .days-indicator.danger {
        background: #fff5f5;
        border-left-color: #dc3545;
    }
    
    .days-number {
        font-size: 2rem;
        font-weight: bold;
        color: #17a2b8;
    }
    
    .days-indicator.warning .days-number {
        color: #ff8c00;
    }
    
    .days-indicator.danger .days-number {
        color: #dc3545;
    }
    
    .comments-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .comment-item {
        border-left: 3px solid #667eea;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 0 10px 10px 0;
        margin-bottom: 15px;
    }
    
    .comment-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .comment-author {
        font-weight: 600;
        color: #495057;
    }
    
    .comment-date {
        font-size: 0.9rem;
        color: #6c757d;
        margin-left: auto;
    }
    
    .comment-text {
        color: #495057;
        line-height: 1.5;
        margin: 0;
    }
    
    .floating-actions {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1000;
    }
    
    .floating-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .floating-btn:hover {
        transform: scale(1.1);
    }
    
    .floating-btn.edit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .floating-btn.back {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Coluna Principal -->
        <div class="col-lg-8">
            <!-- Header do Item -->
            <div class="detail-container">
                <div class="detail-header {{ item.status.lower().replace('_', '-') }}">
                    <span class="status-badge-large">
                        {% if item.status == 'EM_REPARO' %}
                            <i class="fas fa-wrench"></i> Em Reparo
                        {% else %}
                            <i class="fas fa-check-circle"></i> Finalizado
                        {% endif %}
                    </span>
                    <h2 class="mb-2">{{ item.numero_pm05 }}</h2>
                    <p class="mb-1 opacity-75">{{ item.numero_invoice }}</p>
                    <h4 class="mb-0">{{ item.descricao }}</h4>
                </div>
                
                <div class="detail-body">
                    <!-- Indicador de Dias -->
                    {% if item.status == 'EM_REPARO' and item.data_envio %}
                        {% set days_out = days_in_repair if days_in_repair is defined else 0 %}
                        <div class="days-indicator {{ 'danger' if days_out > 30 else 'warning' if days_out > 15 else '' }}">
                            <div>
                                <div class="days-number">{{ days_out }}</div>
                            </div>
                            <div>
                                <strong>
                                    {{ 'dias' if days_out != 1 else 'dia' }} em reparo
                                </strong>
                                <br>
                                <small class="text-muted">
                                    {% if days_out > 30 %}
                                        ⚠️ Prazo excedido - Verificar status
                                    {% elif days_out > 15 %}
                                        ⏰ Acompanhar evolução do reparo
                                    {% else %}
                                        ✅ Dentro do prazo normal
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Grid de Informações -->
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-hashtag"></i> Número PM05
                            </div>
                            <div class="info-value">{{ item.numero_pm05 }}</div>
                        </div>
                        
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-file-invoice"></i> Número Invoice
                            </div>
                            <div class="info-value">{{ item.numero_invoice }}</div>
                        </div>
                        
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-barcode"></i> Catálogo Envio
                            </div>
                            <div class="info-value">{{ item.catalog_envio }}</div>
                        </div>
                        
                        {% if item.catalog_ersa %}
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-barcode"></i> Catálogo ERSA
                            </div>
                            <div class="info-value">{{ item.catalog_ersa }}</div>
                        </div>
                        {% endif %}
                        
                        <div class="info-card {{ 'success' if item.status == 'FINALIZADO' else 'warning' }}">
                            <div class="info-label">
                                <i class="fas fa-building"></i> Fornecedor
                            </div>
                            <div class="info-value">{{ item.fornecedor }}</div>
                        </div>
                        
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-cubes"></i> Quantidade
                            </div>
                            <div class="info-value">{{ item.quantidade }} unidade(s)</div>
                        </div>
                        
                        {% if item.data_envio %}
                        <div class="info-card warning">
                            <div class="info-label">
                                <i class="fas fa-calendar-alt"></i> Data de Envio
                            </div>
                            <div class="info-value">{{ format_date(item.data_envio) }}</div>
                        </div>
                        {% endif %}
                        
                        {% if item.data_retorno %}
                        <div class="info-card success">
                            <div class="info-label">
                                <i class="fas fa-calendar-check"></i> Data de Retorno
                            </div>
                            <div class="info-value">{{ format_date(item.data_retorno) if item.data_retorno else 'N/A' }}</div>
                        </div>
                        {% endif %}
                        
                        {% if item.nf_saida %}
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-file-invoice"></i> NF Saída
                            </div>
                            <div class="info-value">{{ item.nf_saida }}</div>
                        </div>
                        {% endif %}
                        
                        {% if item.nf_retorno %}
                        <div class="info-card success">
                            <div class="info-label">
                                <i class="fas fa-file-invoice-dollar"></i> NF Retorno
                            </div>
                            <div class="info-value">{{ item.nf_retorno }}</div>
                        </div>
                        {% endif %}
                        
                        {% if item.valor_reparo %}
                        <div class="info-card">
                            <div class="info-label">
                                <i class="fas fa-dollar-sign"></i> Valor do Reparo
                            </div>
                            <div class="info-value">R$ {{ "%.2f"|format(item.valor_reparo) }}</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Especificações Técnicas -->
                    {% if item.spec %}
                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-cogs"></i> Especificações Técnicas
                        </div>
                        <div class="info-value" style="white-space: pre-wrap;">{{ item.spec }}</div>
                    </div>
                    {% endif %}
                    
                    <!-- Observações -->
                    {% if item.observacoes %}
                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-sticky-note"></i> Observações Iniciais
                        </div>
                        <div class="info-value" style="white-space: pre-wrap;">{{ item.observacoes }}</div>
                    </div>
                    {% endif %}
                    
                    {% if item.observacoes_retorno %}
                    <div class="info-card success">
                        <div class="info-label">
                            <i class="fas fa-clipboard-check"></i> Observações do Retorno
                        </div>
                        <div class="info-value" style="white-space: pre-wrap;">{{ item.observacoes_retorno }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Timeline -->
            <div class="timeline-container">
                <h5 class="mb-4">
                    <i class="fas fa-history"></i> Histórico do Item
                </h5>
                
                <div class="timeline">
                    <div class="timeline-item completed">
                        <div class="timeline-content">
                            <div class="timeline-date">{{ format_datetime(item.data_criacao) if item.data_criacao else 'N/A' }}</div>
                            <div class="timeline-title">Item PM05 Criado</div>
                            <div class="timeline-description">
                                Item {{ item.numero_pm05 }} foi registrado no sistema para reparo em {{ item.fornecedor }}
                            </div>
                        </div>
                    </div>
                    
                    {% if item.data_envio %}
                    <div class="timeline-item {{ 'completed' if item.status == 'FINALIZADO' else 'warning' }}">
                        <div class="timeline-content">
                            <div class="timeline-date">{{ format_date(item.data_envio) }}</div>
                            <div class="timeline-title">Equipamento Enviado</div>
                            <div class="timeline-description">
                                Equipamento enviado para reparo no fornecedor {{ item.fornecedor }}
                                {% if item.nf_saida %} - NF: {{ item.nf_saida }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.status == 'FINALIZADO' and item.data_retorno %}
                    <div class="timeline-item completed">
                        <div class="timeline-content">
                            <div class="timeline-date">{{ format_date(item.data_retorno) if item.data_retorno else 'N/A' }}</div>
                            <div class="timeline-title">Equipamento Retornado</div>
                            <div class="timeline-description">
                                Equipamento retornado do reparo e recebido
                                {% if item.nf_retorno %} - NF: {{ item.nf_retorno }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Documentos -->
            {% if item.documentos %}
            <div class="timeline-container">
                <h5 class="mb-4">
                    <i class="fas fa-paperclip"></i> Documentos Anexados
                </h5>
                
                <div class="documents-grid">
                    {% for doc in item.documentos %}
                    <a href="{{ url_for('download_documento_pm05', item_id=item.id, filename=doc.nome_arquivo) }}" 
                       class="document-card" target="_blank">
                        <div class="document-icon {{ 'pdf' if doc.tipo == 'application/pdf' else 'image' if 'image' in doc.tipo else 'word' if 'word' in doc.tipo else '' }}">
                            <i class="fas fa-{{ 'file-pdf' if doc.tipo == 'application/pdf' else 'file-image' if 'image' in doc.tipo else 'file-word' if 'word' in doc.tipo else 'file' }}"></i>
                        </div>
                        <div class="document-name">{{ doc.nome_arquivo }}</div>
                        <div class="document-size">{{ (doc.tamanho / 1024 / 1024)|round(2) }} MB</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Painel de Ações -->
        <div class="col-lg-4">
            <div class="action-panel">
                <h5 class="mb-3">
                    <i class="fas fa-tools"></i> Ações
                </h5>
                
                {% if item.status == 'EM_REPARO' %}
                    <button class="action-btn btn-success-custom" onclick="finalizarItem()">
                        <i class="fas fa-check-circle"></i>
                        Finalizar Reparo
                    </button>
                {% endif %}
                
                <a href="{{ url_for('editar_pm05', id=item.id) }}" class="action-btn btn-primary-custom">
                    <i class="fas fa-edit"></i>
                    Editar Item
                </a>
                
                <button class="action-btn btn-warning-custom" onclick="adicionarComentario()">
                    <i class="fas fa-comment-plus"></i>
                    Adicionar Comentário
                </button>
                
                <button class="action-btn btn-secondary-custom" onclick="gerarRelatorio()">
                    <i class="fas fa-file-pdf"></i>
                    Gerar Relatório
                </button>
                
                <hr class="my-3">
                
                <a href="{{ url_for('listar_pm05') }}" class="action-btn btn-secondary-custom">
                    <i class="fas fa-arrow-left"></i>
                    Voltar à Lista
                </a>
                
                {% if current_user.is_admin %}
                <button class="action-btn btn-danger-custom" onclick="excluirItem()">
                    <i class="fas fa-trash"></i>
                    Excluir Item
                </button>
                {% endif %}
            </div>
            
            <!-- Estatísticas Rápidas -->
            <div class="action-panel">
                <h6 class="mb-3">
                    <i class="fas fa-chart-bar"></i> Estatísticas
                </h6>
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="fw-bold text-primary fs-4">{{ stats.mesmo_fornecedor }}</div>
                        <small class="text-muted">Mesmo Fornecedor</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold text-info fs-4">{{ stats.tempo_medio }}d</div>
                        <small class="text-muted">Tempo Médio</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botões Flutuantes -->
<div class="floating-actions">
    <button type="button" class="floating-btn edit" onclick="window.location.href='{{ url_for('editar_pm05', id=item.id) }}'" 
            title="Editar Item">
        <i class="fas fa-edit"></i>
    </button>
    <button type="button" class="floating-btn back" onclick="window.location.href='{{ url_for('listar_pm05') }}'" 
            title="Voltar">
        <i class="fas fa-arrow-left"></i>
    </button>
</div>

<!-- Modal para Finalizar Item -->
<div class="modal fade" id="finalizarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i> Finalizar Item PM05
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="finalizarForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">NF de Retorno *</label>
                        <input type="text" class="form-control" name="nf_retorno" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data de Retorno *</label>
                        <input type="date" class="form-control" name="data_retorno" 
                               value="{{ today_date }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações do Retorno</label>
                        <textarea class="form-control" name="observacoes_retorno" rows="4"
                                  placeholder="Condições do equipamento, observações do reparo, garantia..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Anexar Documentos</label>
                        <input type="file" class="form-control" name="documentos" multiple
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <small class="text-muted">Fotos do equipamento reparado, laudos, certificados...</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Finalizar Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Comentário -->
<div class="modal fade" id="comentarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comment-plus"></i> Adicionar Comentário
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="comentarioForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Comentário *</label>
                        <textarea class="form-control" name="comentario" rows="4" required
                                  placeholder="Digite seu comentário sobre o item PM05..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Comentário
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function finalizarItem() {
    const modal = new bootstrap.Modal(document.getElementById('finalizarModal'));
    modal.show();
}

function adicionarComentario() {
    const modal = new bootstrap.Modal(document.getElementById('comentarioModal'));
    modal.show();
}

function gerarRelatorio() {
    window.open(`/pm05/relatorio/{{ item.id }}`, '_blank');
}

function excluirItem() {
    if (confirm('Tem certeza que deseja excluir este item PM05? Esta ação não pode ser desfeita.')) {
        fetch(`/pm05/excluir/{{ item.id }}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                window.location.href = "{{ url_for('listar_pm05') }}";
            } else {
                alert('Erro ao excluir item');
            }
        });
    }
}

// Submissão do formulário de finalização
document.getElementById('finalizarForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalizando...';
    
    try {
        const response = await fetch(`/pm05/finalizar/{{ item.id }}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexão: ' + error.message);
    }
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-check"></i> Finalizar Item';
});

// Submissão do formulário de comentário
document.getElementById('comentarioForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    
    try {
        const response = await fetch(`/pm05/comentario/{{ item.id }}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexão: ' + error.message);
    }
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Comentário';
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Fechar modals
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
            bootstrap.Modal.getInstance(modal).hide();
        });
    }
    
    if (e.key === 'e' && !e.ctrlKey && !e.altKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        window.location.href = "{{ url_for('editar_pm05', id=item.id) }}";
    }
    
    if (e.key === 'f' && !e.ctrlKey && !e.altKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        {% if item.status == 'EM_REPARO' %}
        finalizarItem();
        {% endif %}
    }
});

// Auto-refresh para atualizar contadores de dias
setTimeout(() => {
    if (!document.hidden) {
        location.reload();
    }
}, 600000); // 10 minutos
</script>
{% endblock %}
